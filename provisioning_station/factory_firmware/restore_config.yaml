# Device Restore Configuration
# Factory firmware and restore operations for supported devices

version: "1.0"

devices:
  sensecap_watcher:
    name: "SenseCAP Watcher"
    name_zh: "SenseCAP Watcher"
    type: "watcher_dual_chip"
    description: "Restore ESP32 and Himax firmware via USB"
    description_zh: "通过 USB 烧录恢复 ESP32 和 Himax 出厂固件"

    # ESP32-S3 firmware (flashed first)
    esp32:
      name: "ESP32-S3 Firmware"
      name_zh: "ESP32-S3 固件"
      file: "esp32/factory_firmware.bin"
      flash_config:
        chip: "esp32s3"
        baud_rate: 921600
        flash_mode: "dio"
        flash_freq: "80m"
        flash_size: "16MB"
        address: "0x0"

    # Himax WE2 firmware (flashed after ESP32)
    himax:
      name: "Himax WE2 Firmware"
      name_zh: "Himax WE2 固件"
      file: "himax/himax_firmware_20240816.img"
      flash_config:
        baudrate: 921600
        timeout: 60

    detection:
      # WCH CH343 USB-Serial (shared by ESP32 and Himax)
      usb_vendor_id: "0x1a86"
      usb_product_id: "0x55d2"
      fallback_ports:
        - "/dev/cu.usbmodem*"
        - "/dev/tty.usbmodem*"
        - "/dev/ttyACM*"
        - "COM*"

  recamera:
    name: "reCamera"
    name_zh: "reCamera"
    type: "ssh_restore"
    description: "Restore by removing deployed packages and services"
    description_zh: "通过卸载已部署的包和服务进行还原"

    restore_operations:
      # Step 1: Stop deployed services
      - name: "Stop deployed services"
        name_zh: "停止已部署的服务"
        command: |
          for svc in /etc/init.d/S*yolo* /etc/init.d/S*detector*; do
            [ -f "$svc" ] && sudo $svc stop 2>/dev/null || true
          done

      # Step 2: Remove deployed packages
      - name: "Remove deployed packages"
        name_zh: "卸载已部署的包"
        command: |
          pkgs=$(opkg list-installed 2>/dev/null | grep -E 'yolo.*-detector' | cut -d' ' -f1)
          for pkg in $pkgs; do
            sudo opkg remove $pkg 2>/dev/null || true
          done

      # Step 3: Remove deployed models (NOT factory models)
      - name: "Remove deployed models"
        name_zh: "删除部署添加的模型"
        command: |
          # Only remove models from /userdata/local/models/
          # DO NOT remove factory models from:
          # - /userdata/Models/model.cvimodel
          # - /userdata/MODEL/model.cvimodel
          sudo rm -rf /userdata/local/models/* 2>/dev/null || true

      # Step 4: Restore all Node-RED related services autostart
      - name: "Restore Node-RED services autostart"
        name_zh: "恢复 Node-RED 相关服务自启动"
        command: |
          # Restore node-red (K03 -> S03)
          [ -f /etc/init.d/K03node-red ] && sudo mv /etc/init.d/K03node-red /etc/init.d/S03node-red 2>/dev/null || true
          # Restore sscma-node (K91 -> S91)
          [ -f /etc/init.d/K91sscma-node ] && sudo mv /etc/init.d/K91sscma-node /etc/init.d/S91sscma-node 2>/dev/null || true
          # Restore sscma-supervisor (K93 -> S93)
          [ -f /etc/init.d/K93sscma-supervisor ] && sudo mv /etc/init.d/K93sscma-supervisor /etc/init.d/S93sscma-supervisor 2>/dev/null || true

      # Step 5: Start all Node-RED related services
      - name: "Start Node-RED services"
        name_zh: "启动 Node-RED 相关服务"
        command: |
          # Start services in order
          for svc in /etc/init.d/S*node-red /etc/init.d/S*sscma-node /etc/init.d/S*sscma-supervisor; do
            [ -f "$svc" ] && sudo $svc start 2>/dev/null || true
          done

    factory_paths:
      # These paths contain factory models - DO NOT DELETE
      protected:
        - "/userdata/Models/model.cvimodel"
        - "/userdata/MODEL/model.cvimodel"

      # These paths contain deployment-added content - CAN DELETE
      removable:
        - "/userdata/local/models/"

    default_credentials:
      username: "root"
      port: 22
