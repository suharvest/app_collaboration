# Xiaozhi Remote Display Server
# Deploy on Raspberry Pi / reComputer for large screen display
#
# Usage:
#   docker compose up -d
#
# Configure via environment variables or .env file:
#   RD_DEVICE_NAME=客厅显示器
#   RD_PORT=8765
#   RD_LOCAL_AUDIO=1  (enable server-side audio, default: browser only)
#   PUID=1000  (user ID for PulseAudio, run `id -u` to check)

services:
  xiaozhi-display:
    image: sensecraft-missionpack.seeed.cn/solution/xiaozhi-display:0.3.0
    container_name: xiaozhi-display
    restart: unless-stopped

    # Network settings
    # Note: ports mapping is ignored when using host network mode
    network_mode: host  # Required for mDNS service discovery

    # Audio device passthrough (for HDMI/speaker output)
    devices:
      - /dev/snd:/dev/snd

    # Share system sockets for audio and mDNS
    volumes:
      # PulseAudio socket (use PUID env var for user ID)
      - /run/user/${PUID:-1000}/pulse:/run/user/${PUID:-1000}/pulse:ro
      # D-Bus for Avahi/mDNS (optional, may not exist on all systems)
      - /var/run/dbus:/var/run/dbus:ro

    # Environment configuration
    environment:
      # Device name shown in mDNS and Web UI
      - RD_DEVICE_NAME=${RD_DEVICE_NAME:-Xiaozhi Display}
      # Server port (default: 8765)
      - RD_PORT=${RD_PORT:-8765}
      # Enable server-side audio (HDMI/speaker), default: browser only
      - RD_LOCAL_AUDIO=${RD_LOCAL_AUDIO:-0}
      # Display scale factor
      - RD_SCALE=${RD_SCALE:-1.5}
      # PulseAudio server for audio output
      - PULSE_SERVER=unix:/run/user/${PUID:-1000}/pulse/native
      # Timezone
      - TZ=${TZ:-Asia/Shanghai}

    # Container capabilities
    group_add:
      - audio  # Access to audio devices

    # Logging configuration
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

    # Health check
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:${RD_PORT:-8765}/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
