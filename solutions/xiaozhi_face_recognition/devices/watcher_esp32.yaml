version: "1.0"
id: watcher_esp32
name: Xiaozhi ESP32 Firmware
name_zh: 小智 ESP32 固件
type: esp32_usb

detection:
  method: usb_serial
  # Watcher uses WCH USB-UART chip
  usb_vendor_id: "0x1a86"
  usb_product_id: "0x55d2"
  # Fallback patterns for different platforms
  fallback_ports:
    - "/dev/tty.wchusbserial*"
    - "/dev/cu.wchusbserial*"
    - "/dev/tty.usbserial-*"
    - "/dev/cu.usbserial-*"
    - "/dev/ttyUSB*"
    - "/dev/ttyACM*"

firmware:
  source:
    type: local
    path: assets/watcher_firmware/merged-binary.bin
  flash_config:
    chip: esp32s3
    baud_rate: 921600
    flash_mode: dio
    flash_freq: 80m
    flash_size: 16MB
    partitions:
      - name: merged_firmware
        offset: "0x0"
        file: merged-binary.bin

user_inputs:
  - id: serial_port
    name: Serial Port
    name_zh: 串口
    type: serial_port
    required: true
    description: Select the USB serial port (wchusbserial)
    description_zh: 选择 USB 串口（wchusbserial 开头）
    auto_detect: true

pre_checks:
  - type: serial_port_available
    description: Check if serial port is accessible
  - type: esptool_available
    description: Check if esptool is installed

steps:
  - id: detect_chip
    name: Detect Chip
    name_zh: 检测芯片
    description: Verify ESP32-S3 chip is detected
    description_zh: 验证 ESP32-S3 芯片已检测到
    optional: false
    default: true

  - id: flash_firmware
    name: Flash Firmware
    name_zh: 烧录固件
    description: Write Xiaozhi firmware to flash memory
    description_zh: 将小智固件写入闪存
    optional: false
    default: true

  - id: verify_flash
    name: Verify Flash
    name_zh: 验证烧录
    description: Verify firmware was written correctly
    description_zh: 验证固件写入正确
    optional: true
    default: true

  - id: reset_device
    name: Reset Device
    name_zh: 重启设备
    description: Reset device to boot new firmware
    description_zh: 重启设备以启动新固件
    optional: false
    default: true

post_deployment:
  reset_device: true
  wait_for_ready: 3
