version: "1.0"
id: xiaozhi_remote
name: Xiaozhi Voice Server (Remote)
name_zh: 小智语音服务（远程）
type: docker_remote

detection:
  method: network_scan
  manual_entry: true
  requirements:
    - docker_installed
    - docker_running

ssh:
  port: 22
  default_user: root
  auth_methods:
    - password
    - key
  connection_timeout: 30
  command_timeout: 600

docker_remote:
  compose_file: assets/docker/docker-compose-xiaozhi.yml
  compose_dir: assets/docker
  remote_path: /home/{{username}}/xiaozhi_voice

  environment:
    TZ: Asia/Shanghai

  options:
    project_name: xiaozhi_voice
    remove_orphans: true

  services:
    - name: xiaozhi-server
      port: 18000
      health_check_endpoint: /xiaozhi/ota/
      health_check_port: 18003
      required: true
    - name: mcp-endpoint
      port: 18004
      required: true

  images:
    - name: ghcr.nju.edu.cn/xinnan-tech/xiaozhi-esp32-server:server_arm64
      required: true
    - name: ghcr.nju.edu.cn/xinnan-tech/mcp-endpoint-server:latest
      required: true

user_inputs:
  # SSH 连接配置
  - id: host
    name: Host / IP
    name_zh: 主机 / IP 地址
    type: text
    required: true
    default: "reComputer-R110x.local"
    placeholder: "reComputer-R110x.local"
    description: Hostname or IP address of the reComputer R1100 device
    description_zh: reComputer R1100 设备的主机名或 IP 地址

  - id: username
    name: SSH Username
    name_zh: SSH 用户名
    type: text
    default: recomputer
    required: true
    description: SSH login username
    description_zh: SSH 登录用户名

  - id: password
    name: SSH Password
    name_zh: SSH 密码
    type: password
    default: "12345678"
    required: true
    description: SSH login password
    description_zh: SSH 登录密码

  - id: port
    name: SSH Port
    name_zh: SSH 端口
    type: text
    default: "22"
    required: false
    description: SSH port (default 22)
    description_zh: SSH 端口（默认 22）

  # 部署方案选择
  - id: deploy_mode
    name: Deployment Mode
    name_zh: 部署方案
    type: select
    required: true
    options:
      - value: private_cloud
        label: Private Cloud (Cloud LLM/TTS)
        label_zh: 私有云方案（云端 LLM/TTS）
      - value: edge_computing
        label: Edge Computing (Jetson LLM/TTS)
        label_zh: 边缘计算方案（Jetson LLM/TTS）
    default: private_cloud
    description: Choose deployment architecture
    description_zh: 选择部署架构

  # 私有云方案 - LLM 配置
  - id: llm_base_url
    name: LLM API Base URL
    name_zh: LLM API 地址
    type: text
    required: false
    placeholder: "https://api.deepseek.com/v1"
    description: "OpenAI-compatible API endpoint (e.g., DeepSeek, OpenAI, Moonshot)"
    description_zh: "兼容 OpenAI 的 API 端点（如 DeepSeek、OpenAI、月之暗面）"
    show_when:
      field: deploy_mode
      value: private_cloud

  - id: llm_model_name
    name: LLM Model Name
    name_zh: LLM 模型名称
    type: text
    required: false
    placeholder: "deepseek-chat"
    description: "Model name to use"
    description_zh: "使用的模型名称"
    show_when:
      field: deploy_mode
      value: private_cloud

  - id: llm_api_key
    name: LLM API Key
    name_zh: LLM API 密钥
    type: password
    required: false
    placeholder: "sk-..."
    description: "API key for LLM service"
    description_zh: "LLM 服务的 API 密钥"
    show_when:
      field: deploy_mode
      value: private_cloud

  # 私有云方案 - TTS 配置
  - id: tts_type
    name: TTS Provider
    name_zh: TTS 服务商
    type: select
    required: false
    options:
      - value: openai
        label: OpenAI TTS
        label_zh: OpenAI TTS
      - value: azure
        label: Azure Speech
        label_zh: Azure 语音
      - value: volcengine
        label: Volcengine (火山引擎)
        label_zh: 火山引擎
      - value: aliyun
        label: Aliyun (阿里云)
        label_zh: 阿里云
      - value: edge
        label: Edge TTS (Free)
        label_zh: Edge TTS（免费）
    default: edge
    description: "Choose TTS service provider"
    description_zh: "选择 TTS 服务商"
    show_when:
      field: deploy_mode
      value: private_cloud

  - id: tts_base_url
    name: TTS API Base URL
    name_zh: TTS API 地址
    type: text
    required: false
    placeholder: "https://api.openai.com/v1"
    description: "TTS API endpoint (not needed for Edge TTS)"
    description_zh: "TTS API 端点（Edge TTS 不需要）"
    show_when:
      field: deploy_mode
      value: private_cloud

  - id: tts_api_key
    name: TTS API Key
    name_zh: TTS API 密钥
    type: password
    required: false
    placeholder: "sk-..."
    description: "API key for TTS service (not needed for Edge TTS)"
    description_zh: "TTS 服务的 API 密钥（Edge TTS 不需要）"
    show_when:
      field: deploy_mode
      value: private_cloud

  - id: tts_voice
    name: TTS Voice
    name_zh: TTS 语音
    type: text
    required: false
    placeholder: "zh-CN-XiaoxiaoNeural"
    description: "Voice ID or name"
    description_zh: "语音 ID 或名称"
    default: "zh-CN-XiaoxiaoNeural"
    show_when:
      field: deploy_mode
      value: private_cloud

  # 边缘计算方案 - Jetson 配置
  - id: jetson_ip
    name: Jetson IP Address
    name_zh: Jetson IP 地址
    type: text
    required: false
    placeholder: "192.168.1.200"
    description: "IP address of Jetson device running LLM/TTS (auto-filled if deployed in previous step)"
    description_zh: "运行 LLM/TTS 的 Jetson 设备 IP 地址（如已在上一步部署则自动填充）"
    show_when:
      field: deploy_mode
      value: edge_computing
    # 从 Jetson 部署步骤获取值
    import_from: JETSON_IP

pre_checks:
  - type: docker_version
    min_version: "20.0"
    description: Check Docker version
  - type: docker_compose_version
    min_version: "2.0"
    description: Check Docker Compose version

steps:
  - id: connect
    name: SSH Connect
    name_zh: SSH 连接
    description: Connect to R1100 device via SSH
    description_zh: 通过 SSH 连接 R1100 设备
    optional: false
    default: true

  - id: prepare
    name: Prepare Directory
    name_zh: 准备目录
    description: Create deployment directory on remote
    description_zh: 在远程设备上创建部署目录
    optional: false
    default: true

  - id: upload
    name: Upload Files
    name_zh: 上传文件
    description: Upload Docker Compose and config files
    description_zh: 上传 Docker Compose 和配置文件
    optional: false
    default: true

  - id: pull_images
    name: Pull Docker Images
    name_zh: 拉取 Docker 镜像
    description: Download container images on remote device
    description_zh: 在远程设备上下载容器镜像
    optional: false
    default: true

  - id: start_services
    name: Start Services
    name_zh: 启动服务
    description: Launch Docker containers
    description_zh: 启动 Docker 容器
    optional: false
    default: true

  - id: health_check
    name: Health Check
    name_zh: 健康检查
    description: Verify services are running correctly
    description_zh: 验证服务运行正常
    optional: false
    default: true

post_deployment:
  message: "Xiaozhi voice server is running on {{host}}. WebSocket: ws://{{host}}:18000/xiaozhi/v1/"
  message_zh: "小智语音服务已在 {{host}} 上启动。WebSocket: ws://{{host}}:18000/xiaozhi/v1/"
