version: "1.0"
id: recamera_ppocr
name: reCamera PP-OCRv3 Reader
name_zh: reCamera PP-OCRv3 文字识别
type: recamera_cpp

detection:
  method: network_scan
  manual_entry: true
  requirements: []

# SSH 连接配置（用户是 recamera，非 root）
ssh:
  port: 22
  default_user: recamera
  default_host: 192.168.42.1
  connection_timeout: 30
  command_timeout: 300

# C++ 应用部署配置
binary:
  # .deb 包安装（包含 init 脚本 S92ppocr-reader）
  deb_package:
    path: packages/ppocr-reader_0.3.0_riscv64.deb
    name: ppocr-reader
    includes_init_script: true

  # 模型文件部署（检测模型 + 中英文识别模型 + 字典文件）
  models:
    # Detection model (shared)
    - path: packages/ppocr_det_cv181x_mix.cvimodel
      target_path: /userdata/local/models
      filename: ppocr_det_cv181x_mix.cvimodel
    # Chinese recognition model
    - path: packages/ppocr_rec_cv181x_bf16.cvimodel
      target_path: /userdata/local/models
      filename: ppocr_rec_cv181x_bf16.cvimodel
    # Chinese dictionary
    - path: packages/ppocr_keys_v1.txt
      target_path: /userdata/local/dict
      filename: ppocr_keys_v1.txt
    # English recognition model
    - path: packages/ppocr_rec_en_cv181x_bf16.cvimodel
      target_path: /userdata/local/models
      filename: ppocr_rec_en_cv181x_bf16.cvimodel
    # English dictionary
    - path: packages/en_dict.txt
      target_path: /userdata/local/dict
      filename: en_dict.txt

  # 服务配置（deb 包已含 init 脚本）
  service_name: ppocr-reader
  service_priority: 92

  auto_start: true

actions:
  after:
    - name: Configure English OCR models
      name_zh: 配置英文 OCR 模型
      when:
        field: language
        value: english
      run: |
        cat > /etc/ppocr-reader.conf << 'EOF'
        DAEMON_OPTS="--det-model /userdata/local/models/ppocr_det_cv181x_mix.cvimodel --rec-model /userdata/local/models/ppocr_rec_en_cv181x_bf16.cvimodel --dict /userdata/local/dict/en_dict.txt"
        EOF
      sudo: true
    - name: Configure Chinese OCR models (default)
      name_zh: 配置中文 OCR 模型（默认）
      when:
        field: language
        value: chinese
      run: |
        rm -f /etc/ppocr-reader.conf
      sudo: true
    - name: Enable external MQTT access
      name_zh: 启用 MQTT 外部访问
      run: |
        CONF="/etc/mosquitto/mosquitto.conf"
        grep -q 'listener 1883 0.0.0.0' "$CONF" 2>/dev/null && exit 0
        echo "listener 1883 0.0.0.0" >> "$CONF"
        echo "allow_anonymous true" >> "$CONF"
        killall mosquitto 2>/dev/null || true
        sleep 1
        /usr/sbin/mosquitto -c "$CONF" -d
      sudo: true
    - name: Disable Node-RED autostart
      name_zh: 禁用 Node-RED 自启动
      run: |
        for svc in node-red sscma-node sscma-supervisor; do
          for f in /etc/init.d/S*${svc}*; do
            [ -f "$f" ] && mv "$f" "$(echo "$f" | sed 's|/S|/K|')" 2>/dev/null
          done
        done
        true
      sudo: true

# 用户输入
user_inputs:
  - id: language
    name: Recognition Language
    name_zh: 识别语言
    type: select
    default: "chinese"
    description: Choose the OCR recognition language
    description_zh: 选择文字识别语言
    required: true
    options:
      - value: chinese
        label: Chinese (中文)
        label_zh: 中文
      - value: english
        label: English
        label_zh: 英文

  - id: host
    name: Device IP Address
    name_zh: 设备 IP 地址
    type: text
    default: "192.168.42.1"
    placeholder: "192.168.42.1"
    description: IP address of your reCamera (USB default 192.168.42.1)
    description_zh: reCamera 的 IP 地址（USB 默认 192.168.42.1）
    required: true
    validation:
      pattern: "^\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}$"

  - id: password
    name: SSH Password
    name_zh: SSH 密码
    type: password
    default: "recamera"
    description: SSH password (try 'recamera' or 'recamera.2')
    description_zh: SSH 密码（尝试 'recamera' 或 'recamera.2'）
    required: true

post_deployment:
  open_browser: false
